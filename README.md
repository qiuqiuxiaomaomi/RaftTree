# RaftTree
Raft一致性协议

<pre>
      来自于Stanford的新的分布式协议研究称为Raft，它是一个为真实的世界应用建立的协议，主要
   注重协议的落地性和可理解性。

   Consensus:
            它是指多个服务器在状态达成一致，但是在一个分布式系统中，因为各种意外可能，有的
      服务器可能会崩溃或变得不可靠，它就不能和其他服务器达成一致。这种就需要一种Consensus协
      议，一致性协议是为了确保容错性，也就是即使系统中有一两个服务器宕机，也不会影响其处理过程。

            为了以容错方式达成一致，我们不可能要求所有服务器100%都达成一致状态，只要超过
      半数的大多数服务器达成一致就可以了，假设有N台服务器， N/2 + 1就超过半数，代表大多数了。
            在Raft中，任何时候一个服务器可以扮演下面角色之一：
            1：Leader:处理所有客户端交互，日志复制等，一般一次只有一个Leader
            2：Follower：类似选民，完全被动，请求的被动更新者，从Leader接受更新请求，然
               后写如本地日志文件。
            3：Candidate候选人：类似于Proposer律师，可以被选为一个新的领导人，如果Follower
               副本在一段时间内没有收到Leader副本的心跳，则判断Leader可能已经故障，此时启动选举
               过程，此时副本会变成Candidate状态，直到选举结束。

      Raft阶段分为两个，首先是选举过程，然后在选举出来的领导人带领进行正常操作，比如日志复
      制等，下面用途展示这个过程：
            1：任何一个服务器都可以成为一个候选者Candidate，它向其他服务器Follower发出
               要求选举自己的请求。
            2：如果其他服务器统一了，发出OK，如果这个过程中有个Follower宕机，没有收到请求
               选举的要求，因此候选者可以自己选自己，只要达到N/2+1的大多数票，候选人还是可
               已成为Leader的。

    Raft是一种管理复制日志的一致性算法.
    它的首要设计目的就是易于理解，所以在选主的冲突处理等方式上它都选择了非常简单明了的解决方案。
    Raft将一致性拆分为几个关键元素。
        1：Leader选举
        2：日志复制
        3：安全性
    
</pre>

<pre>
Raft Leader选举
   任期(term)
      Raft把时间分为连续的任期（term），每个任期可以是任意时长，任期用连续的整数进行标号，
      每个任期首先进行Leader选举，选举时，多个candidate竞争成为Leader，一旦某个节点成为
      Leader，其他candidate则变成follower，成为Leader的节点将在该任期内一直担任Leader,
      如果该Leader发生故障，其他节点会在新的任期内进行选举，任何一个任期内都不会有多
      个Leader.Raft系统中，任期是一个极其重要的概念，每个节点都维护着当前任期的值，每次节
      点间的通信都会包含任期信息，每个节点在检测自己的任期低于其他节点，都会更新自己的任期
      ，设置为检测到的较高的值，当Leader和candidate发现自己的任期低于别的节点，则立即
      转换为follower.

   Leader选举
    
      Raft采用心跳机制触发Leader选举。当系统启动时，所有节点初始化为Follower状态，设置任
      期为0，并启动定时器，计时器超时后，Follower节点转化为Candidate节点，一旦转化为
      Candidate节点，立即开始以下几件事情：
         1）增加自己的任期数
         2）启动一个新的计数器
         3）给自己投一票
         5）向所有其他节点发送RequestVote RPC请求，并等待其他节点回复。

         如果在计时器超时前接收到多数个节点的同意投票，则转换为Leader.如果接受到其他节点的
         AppendEntries心跳RPC,说明其他节点已经被选举为Leader，则转换为Follower。如果计
         时器超时时还没有接受到以上两种信息中的任何一种，则重复步骤1-5，进行新的选择。

         节点在接收到多个节点的投票称为Leader后，会立即向所有节点发送AppendEntries心跳
         RPC。所有Candidate收到心跳RPC后，转换为Follower，选举结束。

         每个Follower在一个任期内只能投一票，采取先到先得的策略。每个Follower有一个计时器
         ，在计时器超时时间仍然没有接收到来自Leader的心跳RPCC，则转换为Candidate，开始请求投票，也就是当期Leader宕掉后，就会有Follower开始转换为Candidate开始投票。

         如果多个节点同时发起投票，每个节点都没有拿到多数票，则增加任期数，在新的任期内重新
         进行投票。有没有可能永远会出现这种情况，永远选不出Leader呢？


         Raft采取超时机制，Raft系统有一个选举超时配置项，Follower和Candidate的计数器超
         时时间每次重新计算，随机选择配置时间的1倍到2倍，即使所有节点同时启动，由于随机
         超时时间的设置，每个节点一般不会同时转为Candidate，先专为Candidate的节点先发起
         投票，从而获得多数票。因而在每个任期内，多个节点同时请求投票并且都只获得少数票的
         概率很小，连续多次发生这种情况的概率更小，理论上概率更小，实际上可以认为完全不可能
         发生，在测试的Raft实现中，基本上都在1~2个任期内选出Leader.
</pre>